<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solution Makers - Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ§Ø¦Ù‚</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary-color: #6366f1; /* Indigo */
            --secondary-color: #38bdf8; /* Sky Blue */
            --background-dark: #020617; /* Dark Slate */
            --text-light: #e2e8f0; /* Light Gray */
            --glass-bg: rgba(255, 255, 255, 0.02);
            --glass-border: rgba(255, 255, 255, 0.08);
            --current-bg-color: var(--background-dark); /* Default body background */
            --current-accent-color: var(--primary-color); /* Default accent for themes */
            --board-background: #0f172a; /* Default whiteboard background */
        }
        body { 
            font-family: 'Cairo', sans-serif; 
            background: var(--current-bg-color); 
            color: var(--text-light); 
            overflow: hidden; 
            height: 100vh; 
            transition: background-color 0.5s ease; /* Smooth transition for theme change */
        }
        .glass { 
            background: var(--glass-bg); 
            backdrop-filter: blur(30px); 
            border: 1px solid var(--glass-border); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .page { 
            position: absolute; 
            inset: 0; 
            padding: 25px; 
            display: none; 
            flex-direction: column; 
            animation: slideUp 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards; 
            overflow-y: auto; 
            padding-bottom: 120px; 
        }
        .active-page { display: flex; }
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(40px) scale(0.98); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        .toast { 
            position: fixed; 
            top: -100px; 
            left: 50%; 
            transform: translateX(-50%); 
            transition: 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 9999; 
            width: 85%; 
            max-width: 350px; 
        }
        .toast.show { top: 30px; }
        .nav-btn { 
            transition: 0.4s; 
            opacity: 0.3; 
            color: var(--text-light); /* Default nav icon color */
        }
        .nav-active { 
            opacity: 1; 
            transform: translateY(-8px); 
            color: var(--current-accent-color); /* Accent color for active nav */
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Whiteboard Specific Styles */
        #whiteboard-canvas {
            border-radius: 20px;
            background-color: var(--board-background);
            border: 1px solid var(--glass-border);
            touch-action: none; /* Disable default touch actions */
        }
        .tool-btn {
            background-color: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-light);
            padding: 10px;
            border-radius: 15px;
            transition: all 0.2s ease;
        }
        .tool-btn.active {
            background-color: var(--current-accent-color);
            border-color: var(--current-accent-color);
            color: white;
        }
    </style>
</head>
<body>

    <div id="toast" class="toast glass px-6 py-4 rounded-[30px] flex items-center gap-4 border-indigo-500/20">
        <div class="bg-indigo-600/30 p-2 rounded-2xl text-xl">âœ¨</div>
        <div id="toast-msg" class="text-xs font-bold leading-relaxed"></div>
    </div>

    <div id="p-login" class="page active-page items-center justify-center text-center bg-[radial-gradient(circle_at_top,_var(--tw-gradient-stops))] from-indigo-900/20 via-slate-950 to-slate-950">
        <div class="w-20 h-20 bg-gradient-to-tr from-indigo-600 to-blue-500 rounded-[30px] flex items-center justify-center mb-8 animate-pulse text-3xl shadow-[0_0_50px_rgba(79,70,229,0.4)]">ğŸ‡´ğŸ‡²</div>
        <h1 class="text-3xl font-black mb-10 font-['Orbitron'] tracking-tighter">SOLUTION MAKERS</h1>
        <p class="text-slate-500 mb-10 text-sm">Ù…Ù†ØµØ© Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ ÙˆØ§Ù„ØªØ±ÙƒÙŠØ² Ù„Ù„Ø¬Ù…ÙŠØ¹</p>
        <input id="user-name" type="text" class="w-full max-w-xs bg-white/5 border border-white/10 p-5 rounded-[25px] text-center outline-none focus:border-indigo-500 text-lg" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ/Ø§Ø³Ù…ÙƒÙ Ù‡Ù†Ø§">
        <button onclick="login()" class="mt-8 w-full max-w-xs bg-current-accent-color py-5 rounded-[25px] font-black text-lg shadow-xl" style="background-color: var(--current-accent-color);">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†ØµØ©</button>
    </div>

    <div id="p-home" class="page no-scrollbar">
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <div id="avatar" class="w-12 h-12 rounded-2xl bg-current-accent-color flex items-center justify-center font-bold text-xl shadow-lg" style="background-color: var(--current-accent-color);"></div>
                <p id="name-display" class="font-black text-lg"></p>
            </div>
            <div class="glass px-4 py-2 rounded-2xl text-yellow-400 font-bold shadow-lg">ğŸ† <span id="xp-points">0</span></div>
        </header>

        <div class="space-y-6">
            <div class="glass p-8 rounded-[40px] text-center relative overflow-hidden">
                <div id="timer" class="text-6xl font-['Orbitron'] font-black mb-6">25:00</div>
                <button id="timer-btn" onclick="toggleTimer()" class="w-full bg-current-accent-color text-white py-4 rounded-3xl font-black text-sm uppercase tracking-widest shadow-lg" style="background-color: var(--current-accent-color);">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ±ÙƒÙŠØ²</button>
            </div>

            <div class="space-y-4">
                <h3 class="font-bold px-2 text-sm opacity-60">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                <div class="glass p-3 rounded-[30px] flex gap-3">
                    <input id="task-input" type="text" class="bg-transparent flex-grow outline-none text-sm px-3" placeholder="Ø£Ø¶Ù Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©...">
                    <button onclick="addTask()" class="bg-current-accent-color w-12 h-12 rounded-2xl font-black text-xl" style="background-color: var(--current-accent-color);">+</button>
                </div>
                <div id="task-list" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <div id="p-whiteboard" class="page no-scrollbar">
        <h2 class="text-2xl font-black mb-6 text-blue-400">Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø°ÙƒÙŠØ© ğŸ¨</h2>
        <div class="flex-grow flex flex-col glass p-4 rounded-[30px]">
            <canvas id="whiteboard-canvas" class="flex-grow w-full rounded-2xl mb-4" style="background-color: var(--board-background);"></canvas>
            <div class="flex justify-around items-center gap-2 mb-4 flex-wrap">
                <button class="tool-btn active" id="tool-pen" onclick="setTool('pen')">âœï¸</button>
                <button class="tool-btn" id="tool-eraser" onclick="setTool('eraser')">ğŸ§¼</button>
                <input type="color" id="color-picker" onchange="setColor(this.value)" class="w-10 h-10 rounded-full border-none p-0 cursor-pointer" value="#FFFFFF">
                <select id="line-width" onchange="setLineWidth(this.value)" class="tool-btn text-sm w-auto">
                    <option value="2">Ø±ÙÙŠØ¹</option>
                    <option value="5" selected>Ù…ØªÙˆØ³Ø·</option>
                    <option value="10">Ø³Ù…ÙŠÙƒ</option>
                </select>
                <button class="tool-btn text-sm" onclick="clearBoard()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
                <button class="tool-btn text-sm bg-green-500" onclick="saveBoard()">Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©</button>
            </div>
            <div class="flex justify-around items-center gap-2 flex-wrap">
                <button class="tool-btn text-sm" onclick="setBoardBackground('#0f172a')">Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø©</button>
                <button class="tool-btn text-sm" onclick="setBoardBackground('#FFFFFF')">Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡</button>
                <button class="tool-btn text-sm" onclick="setBoardBackground('#4ade80')">Ø®Ù„ÙÙŠØ© Ø®Ø¶Ø±Ø§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="p-stat" class="page no-scrollbar">
        <h2 class="text-2xl font-black mb-8">ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ ğŸ“Š</h2>
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="glass p-6 rounded-[35px] text-center">
                <p class="text-[10px] opacity-50 mb-1">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</p>
                <div id="done-count" class="text-2xl font-black text-emerald-400">0</div>
            </div>
            <div class="glass p-6 rounded-[35px] text-center">
                <p class="text-[10px] opacity-50 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</p>
                <div id="xp-stat" class="text-2xl font-black text-current-accent-color" style="color: var(--current-accent-color);">0</div>
            </div>
        </div>
        <div class="glass p-6 rounded-[35px]">
            <h4 class="text-xs font-bold mb-4">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ø§Ù…</h4>
            <div class="h-3 bg-white/5 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-current-accent-color w-0 transition-all duration-1000" style="background-color: var(--current-accent-color);"></div>
            </div>
        </div>
        <div class="glass p-6 rounded-[35px] mt-6 text-center">
            <h4 class="text-xs font-bold mb-2">Ø±ØªØ¨ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h4>
            <p id="user-rank" class="text-xl font-black text-yellow-400">Ù…Ø¨ØªØ¯Ø¦</p>
        </div>
    </div>

    <div id="p-shop" class="page no-scrollbar">
        <h2 class="text-2xl font-black mb-8">Ø§Ù„Ù…ØªØ¬Ø± ğŸ</h2>
        <div class="space-y-4">
            <div class="glass p-5 rounded-[30px] flex justify-between items-center border-indigo-500/20">
                <div class="flex items-center gap-4">
                    <span class="text-2xl">ğŸ’œ</span>
                    <div>
                        <p class="font-bold text-sm">Ø«ÙŠÙ… (Ù„ÙˆÙ†) Ø§Ù„Ø£Ø¯Ø§Ø¡</p>
                        <p class="text-[10px] opacity-50">ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ - 1000 Ù†Ù‚Ø·Ø©</p>
                    </div>
                </div>
                <button onclick="buyItem(1000, 'theme-indigo', 'Ø«ÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø²Ø±Ù‚')" class="bg-indigo-600 px-4 py-2 rounded-xl text-[10px] font-bold">Ø´Ø±Ø§Ø¡</button>
            </div>
            <div class="glass p-5 rounded-[30px] flex justify-between items-center border-emerald-500/20">
                <div class="flex items-center gap-4">
                    <span class="text-2xl">ğŸ’š</span>
                    <div>
                        <p class="font-bold text-sm">Ø«ÙŠÙ… Ø§Ù„Ø®Ø¶Ø±Ø©</p>
                        <p class="text-[10px] opacity-50">Ù„ÙˆÙ† Ø£Ø®Ø¶Ø± Ù…Ù†Ø¹Ø´ - 1500 Ù†Ù‚Ø·Ø©</p>
                    </div>
                </div>
                <button onclick="buyItem(1500, 'theme-emerald', 'Ø«ÙŠÙ… Ø§Ù„Ø®Ø¶Ø±Ø© Ø§Ù„Ø£Ø®Ø¶Ø±')" class="bg-emerald-600 px-4 py-2 rounded-xl text-[10px] font-bold">Ø´Ø±Ø§Ø¡</button>
            </div>
            <div class="glass p-5 rounded-[30px] flex justify-between items-center border-yellow-500/20">
                <div class="flex items-center gap-4">
                    <span class="text-2xl">âœ¨</span>
                    <div>
                        <p class="font-bold text-sm">Ù‚Ù„Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø°Ù‡Ø¨ÙŠ (Ù„Ù„Ø³Ø·ÙˆØ±)</p>
                        <p class="text-[10px] opacity-50">ÙŠÙØªØ­ Ù„ÙˆÙ†Ø§Ù‹ Ø°Ù‡Ø¨ÙŠØ§Ù‹ Ù„Ù„Ø³Ø¨ÙˆØ±Ø© - 750 Ù†Ù‚Ø·Ø©</p>
                    </div>
                </div>
                <button onclick="buyItem(750, 'pen-gold', 'Ù‚Ù„Ù… Ø°Ù‡Ø¨ÙŠ')" class="bg-yellow-600 px-4 py-2 rounded-xl text-[10px] font-bold">Ø´Ø±Ø§Ø¡</button>
            </div>
            <div class="glass p-5 rounded-[30px] flex justify-between items-center border-gray-400/20">
                <div class="flex items-center gap-4">
                    <span class="text-2xl">ğŸ“</span>
                    <div>
                        <p class="font-bold text-sm">Ø®Ù„ÙÙŠØ© Ø§Ù„Ø³Ø¨ÙˆØ±Ø© (ÙˆØ±Ù‚ Ù…Ø³Ø·Ø±)</p>
                        <p class="text-[10px] opacity-50">ÙŠÙØªØ­ Ø®Ù„ÙÙŠØ© Ù…Ù…ÙŠØ²Ø© Ù„Ù„Ø³Ø¨ÙˆØ±Ø© - 500 Ù†Ù‚Ø·Ø©</p>
                    </div>
                </div>
                <button onclick="buyItem(500, 'board-lined', 'Ø®Ù„ÙÙŠØ© Ù…Ø³Ø·Ø±Ø©')" class="bg-gray-400 px-4 py-2 rounded-xl text-[10px] font-bold">Ø´Ø±Ø§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="p-lab" class="page no-scrollbar">
        <h2 class="text-2xl font-black mb-8 text-blue-400">Ù…Ø®ØªØ¨Ø± Ø§Ù„Ø¥Ù„Ù‡Ø§Ù… ğŸ’¡</h2>
        <div class="glass p-8 rounded-[40px] text-center space-y-6">
            <p id="inspiration-quote" class="text-lg italic leading-relaxed">"Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ Ù‡Ùˆ Ø£Ù† ØªØ±Ù‰ Ù…Ø§ ÙŠØ±Ø§Ù‡ Ø§Ù„Ø¬Ù…ÙŠØ¹ØŒ ÙˆØªÙÙƒØ± Ø¨Ù…Ø§ Ù„Ù… ÙŠÙÙƒØ± Ø¨Ù‡ Ø£Ø­Ø¯."</p>
            <button onclick="getNewInspiration()" class="text-xs font-bold text-blue-400 uppercase tracking-widest border border-blue-400/30 px-6 py-2 rounded-full">Ø¥Ù„Ù‡Ø§Ù… Ø¬Ø¯ÙŠØ¯</button>
        </div>
        <div class="glass p-8 rounded-[40px] text-center space-y-6 mt-6">
            <h3 class="text-sm font-bold opacity-70">Ù‡Ù„ ØªØ¹Ù„Ù…ØŸ ğŸ§ </h3>
            <p id="fact-display" class="text-lg italic leading-relaxed">"Ø£ÙˆÙ„ Ù…Ø¨Ø±Ù…Ø¬Ø© ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙƒØ§Ù†Øª Ø£Ø¯Ø§ Ù„ÙˆÙÙ„ÙŠØ³."</p>
            <button onclick="getNewFact()" class="text-xs font-bold text-purple-400 uppercase tracking-widest border border-purple-400/30 px-6 py-2 rounded-full">Ù…Ø¹Ù„ÙˆÙ…Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
    </div>

    <div id="p-about" class="page no-scrollbar">
        <h2 class="text-2xl font-black mb-8 text-orange-400">ÙØ±ÙŠÙ‚ Solution Makers ğŸš€</h2>
        <div class="glass p-8 rounded-[40px] text-center space-y-6">
            <div class="w-24 h-24 bg-gradient-to-tr from-indigo-500 to-blue-400 rounded-[35px] flex items-center justify-center mx-auto mb-4 text-4xl shadow-xl">ğŸ‡´ğŸ‡²</div>
            <p class="text-lg leading-relaxed">Ù†Ø­Ù† ÙØ±ÙŠÙ‚ <span class="text-current-accent-color font-bold" style="color: var(--current-accent-color);">Solution Makers</span> Ù…Ù† Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†ØŒ Ù†Ø¤Ù…Ù† Ø¨Ø£Ù† Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ù‡ÙŠ Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„. Ù†ØµÙ…Ù… Ø­Ù„ÙˆÙ„Ø§Ù‹ Ù…Ø¨ØªÙƒØ±Ø© Ù„Ù†Ø¬Ø¹Ù„ Ø§Ù„ØªØ¹Ù„Ù… Ø£ÙƒØ«Ø± Ù…ØªØ¹Ø© ÙˆÙØ¹Ø§Ù„ÙŠØ© Ù„Ù„Ø¬Ù…ÙŠØ¹.</p>
            <ul class="list-disc list-inside text-left opacity-80 space-y-2 mt-4">
                <li>Ù‡Ø¯ÙÙ†Ø§: ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©.</li>
                <li>Ø±Ø¤ÙŠØªÙ†Ø§: Ø¨Ù†Ø§Ø¡ Ù…Ø¬ØªÙ…Ø¹ Ø¹Ù…Ø§Ù†ÙŠ Ø±Ø§Ø¦Ø¯ ÙÙŠ Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø± Ø§Ù„ØªÙ‚Ù†ÙŠ.</li>
            </ul>
        </div>
    </div>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] h-20 glass rounded-[35px] flex justify-around items-center px-2 z-50 border-white/10">
        <button onclick="nav('home')" id="n-home" class="nav-btn nav-active text-2xl">ğŸ </button>
        <button onclick="nav('whiteboard')" id="n-whiteboard" class="nav-btn text-2xl">ğŸ¨</button>
        <button onclick="nav('stat')" id="n-stat" class="nav-btn text-2xl">ğŸ“Š</button>
        <button onclick="nav('shop')" id="n-shop" class="nav-btn text-2xl">ğŸ</button>
        <button onclick="nav('lab')" id="n-lab" class="nav-btn text-2xl">ğŸ’¡</button>
        <button onclick="nav('about')" id="n-about" class="nav-btn text-2xl">â„¹ï¸</button>
    </nav>

    <script>
        // Global State & Local Storage Management
        let user = {
            name: localStorage.getItem('user_name') || '',
            xp: parseInt(localStorage.getItem('user_xp')) || 0,
            tasks: JSON.parse(localStorage.getItem('user_tasks')) || [],
            completedTasks: parseInt(localStorage.getItem('user_completed_tasks')) || 0,
            theme: localStorage.getItem('user_theme') || 'theme-indigo',
            boughtItems: JSON.parse(localStorage.getItem('user_bought_items')) || [],
            boardData: JSON.parse(localStorage.getItem('user_board_data')) || []
        };

        // Timer State
        let timerInterval = null;
        let timeLeft = 1500; // 25 minutes in seconds

        // Whiteboard State
        let canvas, ctx;
        let isDrawing = false;
        let currentTool = 'pen';
        let currentColor = '#FFFFFF';
        let currentLineWidth = 5;
        let whiteboardBackground = localStorage.getItem('whiteboard_bg') || '#0f172a';
        let defaultPenColor = '#FFFFFF'; // Default pen color, can be changed by items

        const root = document.documentElement;

        // --- Core Functions ---
        function saveUserData() {
            localStorage.setItem('user_name', user.name);
            localStorage.setItem('user_xp', user.xp);
            localStorage.setItem('user_tasks', JSON.stringify(user.tasks));
            localStorage.setItem('user_completed_tasks', user.completedTasks);
            localStorage.setItem('user_theme', user.theme);
            localStorage.setItem('user_bought_items', JSON.stringify(user.boughtItems));
            localStorage.setItem('user_board_data', JSON.stringify(user.boardData));
            localStorage.setItem('whiteboard_bg', whiteboardBackground); // Save board background
            updateUI();
        }

        function notify(message, type = 'info') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = message;
            toast.style.borderColor = type === 'success' ? '#34d399' : type === 'error' ? '#ef4444' : '#6366f1';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function applyTheme(themeName) {
            let accentColor;
            let bgColor;
            switch(themeName) {
                case 'theme-indigo':
                    accentColor = '#6366f1'; // Indigo
                    bgColor = '#020617';
                    break;
                case 'theme-emerald':
                    accentColor = '#10b981'; // Emerald
                    bgColor = '#062017';
                    break;
                case 'theme-gold':
                    accentColor = '#fcd34d'; // Gold (for future)
                    bgColor = '#1a1a02';
                    break;
                default:
                    accentColor = '#6366f1';
                    bgColor = '#020617';
            }
            root.style.setProperty('--current-accent-color', accentColor);
            root.style.setProperty('--current-bg-color', bgColor);
            document.body.style.backgroundColor = bgColor; // Apply directly for body
            user.theme = themeName;
            saveUserData();
        }

        function updateUI() {
            document.getElementById('name-display').innerText = user.name;
            document.getElementById('avatar').innerText = user.name.charAt(0).toUpperCase();
            document.getElementById('xp-points').innerText = user.xp;
            document.getElementById('xp-stat').innerText = user.xp;
            document.getElementById('done-count').innerText = user.completedTasks;
            document.getElementById('progress-bar').style.width = Math.min((user.completedTasks * 10), 100) + "%";
            
            // Update rank
            let rank = 'Ù…Ø¨ØªØ¯Ø¦';
            if (user.xp >= 1000) rank = 'Ù…ÙÙ†Ø¬Ø²';
            if (user.xp >= 3000) rank = 'Ù…ÙØ­ØªØ±Ù';
            if (user.xp >= 7000) rank = 'Ù‚Ø§Ø¦Ø¯';
            if (user.xp >= 15000) rank = 'Ø£Ø³Ø·ÙˆØ±Ø©';
            document.getElementById('user-rank').innerText = rank;

            renderTasks();
            applyTheme(user.theme); // Re-apply theme on UI update
            // Check for bought pen colors and apply
            if (user.boughtItems.includes('pen-gold')) {
                defaultPenColor = '#FFD700'; // Gold color
                if(currentTool === 'pen') setColor(defaultPenColor); // Apply if pen is active
            } else {
                defaultPenColor = '#FFFFFF'; // Reset to default white
            }
            // Check for bought board background
            if (user.boughtItems.includes('board-lined')) {
                // For a lined background, we'd typically set a CSS class or an image.
                // For simplicity here, let's just use a lighter color for now.
                // A true lined background would require a background-image CSS property.
                if(whiteboardBackground === '#0f172a' || whiteboardBackground === '#FFFFFF' || whiteboardBackground === '#4ade80') {
                    // Only change if it's one of the basic ones, not user-set
                    whiteboardBackground = '#e0e7ff'; // Light blueish for "lined paper" effect
                }
            } else {
                 if(whiteboardBackground === '#e0e7ff') { // Reset if it was the "lined" one
                    whiteboardBackground = '#0f172a'; // Reset to dark default
                 }
            }
            root.style.setProperty('--board-background', whiteboardBackground);
            if(canvas) canvas.style.backgroundColor = whiteboardBackground;
        }

        // --- Login & Navigation ---
        function login() {
            const nameInput = document.getElementById('user-name');
            if (!nameInput.value.trim()) {
                notify("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹!", 'error');
                return;
            }
            user.name = nameInput.value.trim();
            saveUserData();
            document.getElementById('p-login').classList.remove('active-page');
            nav('home');
            notify(`Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${user.name}!`, 'success');
        }

        function nav(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active-page'));
            document.getElementById(`p-${pageId}`).classList.add('active-page');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('nav-active'));
            document.getElementById(`n-${pageId}`).classList.add('nav-active');

            if (pageId === 'whiteboard' && !canvas) {
                initializeWhiteboard();
            }
        }

        // --- Timer Functions ---
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        function toggleTimer() {
            const timerBtn = document.getElementById('timer-btn');
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                timerBtn.innerText = "Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„ØªØ±ÙƒÙŠØ²";
                notify("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª Ù…Ø¤Ù‚ØªØ§Ù‹.");
            } else {
                timerBtn.innerText = "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª";
                notify("Ø¨Ø¯Ø£Øª Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ±ÙƒÙŠØ²!");
                timerInterval = setInterval(() => {
                    timeLeft--;
                    document.getElementById('timer').innerText = formatTime(timeLeft);
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                        confetti({ particleCount: 200, spread: 90, origin: { y: 0.6 } });
                        user.xp += 500;
                        saveUserData();
                        notify("Ø£Ø­Ø³Ù†Øª! Ø£ÙƒÙ…Ù„Øª Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ±ÙƒÙŠØ²! +500 Ù†Ù‚Ø·Ø©", 'success');
                        timeLeft = 1500; // Reset for next session
                        document.getElementById('timer').innerText = formatTime(timeLeft);
                        timerBtn.innerText = "Ø¨Ø¯Ø¡ Ø§Ù„ØªØ±ÙƒÙŠØ²";
                    }
                }, 1000);
            }
        }

        // --- Task Functions ---
        function addTask() {
            const taskInput = document.getElementById('task-input');
            const taskText = taskInput.value.trim();
            if (taskText) {
                user.tasks.push({ id: Date.now(), text: taskText });
                taskInput.value = '';
                saveUserData();
                notify("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©!", 'info');
            }
        }

        function renderTasks() {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            user.tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = "glass p-4 rounded-2xl flex justify-between items-center animate-bounce";
                taskElement.innerHTML = `
                    <span>${task.text}</span>
                    <button onclick="completeTask(${task.id})" class="bg-current-accent-color/20 text-current-accent-color px-3 py-2 rounded-xl text-[10px] font-bold" style="border: 1px solid var(--current-accent-color); color: var(--current-accent-color);">ØªÙ…</button>
                `;
                taskList.prepend(taskElement); // Add new tasks to the top
            });
        }

        function completeTask(id) {
            user.tasks = user.tasks.filter(task => task.id !== id);
            user.completedTasks++;
            user.xp += 100;
            saveUserData();
            confetti({ particleCount: 80, spread: 70, origin: { y: 0.7 } });
            notify("Ù…Ù‡Ù…Ø© Ù…ÙƒØªÙ…Ù„Ø©! +100 Ù†Ù‚Ø·Ø©", 'success');
        }

        // --- Shop Functions ---
        function buyItem(cost, itemId, itemName) {
            if (user.xp >= cost) {
                user.xp -= cost;
                user.boughtItems.push(itemId);
                saveUserData();
                confetti({ particleCount: 150, spread: 120, origin: { y: 0.8 } });
                notify(`Ù…Ø¨Ø±ÙˆÙƒ! Ø§Ø´ØªØ±ÙŠØª "${itemName}"!`, 'success');

                // Apply effects immediately
                if (itemId.startsWith('theme-')) {
                    applyTheme(itemId);
                } else if (itemId === 'pen-gold') {
                    defaultPenColor = '#FFD700'; // Gold
                    if(currentTool === 'pen') setColor(defaultPenColor);
                } else if (itemId === 'board-lined') {
                    whiteboardBackground = 'url("data:image/svg+xml,%3Csvg width=\'100%25\' height=\'100%25\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cline x1=\'0\' y1=\'20\' x2=\'100%25\' y2=\'20\' stroke=\'rgba(
